<!DOCTYPE html>
<html>
    <head>
        <title>Are your SPAs safe?</title>
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/prism.css">
        <link rel="stylesheet" href="css/custom.css">
    </head>
    <body>
    <article>
      <section data-bespoke-state="start">
        <div class="content">
          <div class="unbrokenline"></div>
          <h1>Are your SPAs safe?</h1>
          <div class="byline">
            <div class="classy">
              by Eugenio Pace
            </div>
          </div>
          <div class="profile">
            <div class="rounded-image">
              <img src="img/gonto.jpeg">
            </div>
            <h3>@eugenio_pace</h3>
          </div>
        </div>
      </section>

      <section data-bespoke-state="developer">
        <div class="content">
          <div class="byline">
            <div class="classy">
              I am a
            </div>
          </div>
          <h2>software developer</h2>
          <div class="byline">
            <div class="classy">
              from Redmond, WA
            </div>
          </div>
        </div>
      </section>

      <section data-bespoke-state="auth0">
        <div class="content">
          <div class="byline">
            <div class="classy">
              working at
            </div>
          </div>
          <h3>Auth0 Inc.</h3>
          <div class="byline">
            <div class="classy">
              jack of all trades
            </div>
          </div>
        </div>
      </section>

      <section data-bespoke-state="js">
        <div class="content">
          <div class="byline">
            <div class="classy">
              used to be coding
            </div>
          </div>
          <h3>Javascript</h3>
          <div class="byline">
            <div class="classy">
              all day long
            </div>
          </div>
        </div>
      </section>

      <section data-bespoke-state="programming">
        <div class="content"></div>
      </section>

      <section data-bespoke-state="advocate">
        <div class="content">
          <div class="byline">
            <div class="classy">
              Now I work in
            </div>
          </div>
          <h3>Customer Success</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="smoke">
        <div class="content"></div>
      </section>

      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              We're here to learn
            </div>
          </div>
          <h3>most common security issues in SPAs</h3>
          <div class="byline">
          </div>
        </div>
      </section>

      <section>
        <div class="content">
          <h2>Let's dive...</h3>
        </div>
      </section>

      <section data-bespoke-state="dive">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              There's a difference between how
            </div>
          </div>
          <h3>Websites used to work</h3>
          <div class="byline">
            <div class="classy">
              and how
            </div>
          </div>
          <h3>They work now</h3>
          <div class="byline"></div>
        </div>
      </section>

      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              There used to be
            </div>
          </div>
          <h3>Refreshes</h3>
          <div class="byline">
            <div class="classy">
              and everything was
            </div>
          </div>
          <h3>Handled on the server</h3>
          <div class="byline">
            <div class="classy">
              before the UI was rendered
            </div>
          </div>
        </div>
      </section>

      <section data-bespoke-state="old-web safari">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              And now there are
            </div>
          </div>
          <h3>No refreshes</h3>
          <div class="byline">
            <div class="classy">
              and everything is
            </div>
          </div>
          <h3>Handled on the client</h3>
          <div class="byline">
            <div class="classy">
              which
            </div>
          </div>
          <h3>Calls an API</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="current-web safari">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <h2>Everything has changed!</h2>
        </div>
      </section>

      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              This means
            </div>
          </div>
          <h3>We need to learn</h3>
          <div class="byline">
            <div class="classy">
             new
            </div>
          </div>
          <h3>Security Concerns</h3>
          <div class="byline">
            <div class="classy">
              that exist
            </div>
          </div>
        </div>
      </section>

      <section data-bespoke-state="lost">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <h2>Don't worry, we're here to help you</h2>
        </div>
      </section>

      <section>
        <div class="content">
          <h2>Let's start with the simple one</h2>
        </div>
      </section>

      <section data-bespoke-state="subject-change">
        <div class="content">
          <h2>XSRF</h2>
        </div>
      </section>

      <section data-bespoke-state="persian-cat">
        <div class="content">
          <h2>Hi There</h2>
          <h4>Do you want to see a beautiful cat?</h4>
          <input onclick="alert('You shouldn\'t have touched this');bespoke.next();" type="submit" value="Please click here to continue" />
        </div>
      </section>

      <section data-bespoke-state="boom">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <h2>But the real code is</h2>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre data-line="1" ><code class="language-markup">&lt;form method=&quot;POST&quot; action=&quot;http://url-user-is-registered.com/change-email&quot;&gt;
  &lt;input type=&quot;hidden&quot; id=&quot;email&quot; value=&quot;malicious@email.com&quot; /&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Click here to continue&quot; /&gt;
&lt;/form&gt;
</code></pre>
        <p>Sets the URL for your website.</p>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre data-line="2" ><code class="language-markup">&lt;form method=&quot;POST&quot; action=&quot;http://url-user-is-registered.com/change-email&quot;&gt;
  &lt;input type=&quot;hidden&quot; id=&quot;email&quot; value=&quot;malicious@email.com&quot; /&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Click here to continue&quot; /&gt;
&lt;/form&gt;
</code></pre>
        <p>Sets the new email</p>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre data-line="3" ><code class="language-markup">&lt;form method=&quot;POST&quot; action=&quot;http://url-user-is-registered.com/change-email&quot;&gt;
  &lt;input type=&quot;hidden&quot; id=&quot;email&quot; value=&quot;malicious@email.com&quot; /&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Click here to continue&quot; /&gt;
&lt;/form&gt;
</code></pre>
        <p>Shows the button to the user</p>
        </div>
      </section>

      <section data-bespoke-state="not-cool">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <h2>This attack uses cookies from a previously logged in user</h2>
        </div>
      </section>

      <section>
        <div class="content">
          <h2>How do we prevent this in SPAs?</h2>
        </div>
      </section>

      <section data-bespoke-state="options">
        <div class="content">
          <h2>Option 1</h2>
          <div class="byline">
            <div class="classy">
              use
            </div>
          </div>
          <h3>Tokens</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
        <pre><code class="language-markup">&lt;!-- This form will be rendered by the SPA as a template --&gt;
&lt;form&gt;
  &lt;input type=&quot;text&quot; id=&quot;email&quot;/&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Click here to continue&quot; /&gt;
&lt;/form&gt;
</code></pre>
<p></p>
          <pre data-line="7,8"><code class="language-javascript">$.ajax({
  url: '/api/change-email',
  data: {
    email: form.email
  },
  headers: {
    // We get the token from the logged in user. We store it in Local Storage
    Authorization: 'Bearer ' + storage.idToken
  }
});
</code></pre>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre><code class="language-javascript">var tokenValidator = require('express-jwt')

app.use('/api/',  tokenValidator({
  secret: new Buffer(process.env.CLIENT_SECRET, 'base64'),
  audience: process.env.CLIENT_ID
}));

app.post('/api/change-email', function(req, res) {
  // Only if a user has a token can arrive to this point
  // Custom change email logic
});
</code></pre>
        <p>On the server, we validate the <a class="big-label" href="https://docs.auth0.com/jwt">JWT Token</a></p>
        </div>
      </section>

      <section>
        <div class="content">
          <h3>Saved tokens can only be accesable by JS</h3>
        </div>
      </section>

      <section>
        <div class="content">
          <h3>We don't even have to worry about XSRF</h3>
        </div>
      </section>


      <section data-bespoke-state="options">
        <div class="content">
          <h2>Option 2</h2>
          <div class="byline">
            <div class="classy">
              Use
            </div>
          </div>
          <h3>Cookies</h3>
          <div class="byline">
            <div class="classy">
              but also
            </div>
          </div>
          <h3>send a XSRF Nonce</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
        <pre data-line="2,3"><code class="language-markup">&lt;script&gt;
  // This is printed by the server in the main HTML that will display the SPA
  var xsrfToken = ${xsrfTokenValueFromServer}
&lt;/script&gt;</code></pre>
<p></p>
          <pre><code class="language-markup">&lt;!-- This form will be rendered by the SPA as a template --&gt;
&lt;form&gt;
  &lt;input type=&quot;text&quot; id=&quot;email&quot;/&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Click here to continue&quot; /&gt;
&lt;/form&gt;
</code></pre>
<p></p>
          <pre data-line="5-7"><code class="language-javascript">$.ajax({
  url: '/api/change-email',
  data: { email: form.email },
  headers: {
    // We send the CSRF token printed by the server
    // No session info is needed since cookies are used
    'x-xsrf-token': xsrfToken
  }
});
</code></pre>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre data-line="3-5,9,10"><code class="language-javascript">// First we render the Index.html for the SPA with the XSRF token
app.get('/', function(req, res) {
  res.render("index.html", {
    xsrfTokenValueFromServer: createXsrfTokenFromSession()
  });
});

app.post('/api/change-email', function(req, res) {
  // Here we check the token
  if (!validateXsrfTokenWithSession(req.headers['x-xsrf-token'])) {
    res.status(400).text('Cheated form');
  } else {
    // Custom change email logic
  }
});
</code></pre>
        <p>From the server, first we print the XSRF token in the <dfn>index.html</dfn> to the SPA</p>
        <p>Then we verify that the XSRF token in the POST on the API</p>
        </div>
      </section>

      <section>
        <div class="content">
          <div class="unbrokenline"></div>
          <h3>XSRF Nonce</h3>
          <div class="byline">
            <div class="classy">
              assures that
            </div>
          </div>
          <h3>the user POSTing the form</h3>
          <div class="byline">
            <div class="classy">
              obtained it
            </div>
          </div>
          <h3>from our WebApp</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section>
        <div class="content">
          <div class="unbrokenline"></div>
          <h3>The server</h3>
          <div class="byline">
            <div class="classy">
              has to
            </div>
          </div>
          <h3>intervene</h3>
          <div class="byline">
            <div class="classy">
              since due to
            </div>
          </div>
          <h3>Cookies</h3>
          <div class="byline">
            <div class="classy">
              the server traditionally
            </div>
          </div>
          <h3>has state</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="dump-elephant">
        <div class="content"></div>
      </section>



      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We say
            </div>
          </div>
          <h3>Tokens are easier to handle for XSRF</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We think that
            </div>
          </div>
          <h3>Stateless APIs</h3>
          <div class="byline">
            <div class="classy">
              with
            </div>
          </div>
          <h3>tokens</h3>
          <div class="byline">
            <div class="classy">
              make more sense for
            </div>
          </div>
          <h3>SPAs</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We suggest
            </div>
          </div>
          <h3>Using tokens</h3>
          <div class="byline">
            <div class="classy">
              and choosing
            </div>
          </div>
          <h3>Option 1</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="boom-save">
        <div class="content"></div>
      </section>

      <section data-bespoke-state="subject-change">
        <div class="content">
          <h2>APIs</h2>
        </div>
      </section>

      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              creating a
            </div>
          </div>
          <h3>SPA</h3>
          <div class="byline">
            <div class="classy">
              means
            </div>
          </div>
          <h3>Exposing an API</h3>
          <div class="byline">
            <div class="classy">
              as well
            </div>
          </div>
        </div>
      </section>

      <section>
        <div class="content">
          <h3>It's easier to call an API</h3>
        </div>
      </section>

      <section data-bespoke-state="sub-subject-change">
        <div class="content">
          <h2>Request Limit Rate</h2>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre><code class="language-javascript">for(var i = 0; i < 10000000; i++) {
  request({
    url: 'http://yourserver.com/api/signup',
    json: {
      name: 'User' + i,
      email: 'user@mail' + i + '.com'
    }
  });
}</code></pre>
        </div>
      </section>

      <section data-bespoke-state="boom">
        <div class="content">
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre><code class="language-javascript">var RateLimiter = require('limiter').RateLimiter;
// Allow 150 requests per hour (the Twitter search limit)
var limiter = new RateLimiter(150, 'hour');

var rateMiddleware = createExpressMiddleware(limiter);

app.post('/api/signup', rateMiddleware, function(req, res) {
  // Custom signup logic
});</code></pre>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We say
            </div>
          </div>
          <h3>Our Signup API</h3>
          <div class="byline">
            <div class="classy">
              should have
            </div>
          </div>
          <h3>a Captcha or something similar</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We say
            </div>
          </div>
          <h3>Our API</h3>
          <div class="byline">
            <div class="classy">
              should have
            </div>
          </div>
          <h3>Request throttling</h3>
          <div class="byline">
            <div class="classy">
              to avoid
            </div>
          </div>
          <h3>DDoS atacks</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="boom-save">
        <div class="content"></div>
      </section>

      <section data-bespoke-state="sub-subject-change">
        <div class="content">
          <h2>Sanitizing parameters</h2>
        </div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre><code class="language-javascript">request({
  url: 'http://yourserver.com/api/users?id[$exists]=true',
  method: 'GET'
});</code></pre>
<p></p>
<pre><code class="language-javascript"> // Server
app.get('/users', function (req, res) {
   db.collections('customers').findOne({_id: req.query.id}, function (err, customer) {
      res.json(customer);
   });
});</code></pre>
        </div>
      </section>

      <section data-bespoke-state="boom">
        <div class="content"></div>
      </section>

      <section data-bespoke-state="bobby">
        <div class="content"></div>
      </section>

      <section data-bespoke-state="code long">
        <div class="content nofade">
          <pre><code class="language-javascript">var validate = require('isvalid-express');
var getUserValidationSchema = {
    "id": { type: Number, required: true }
};

app.get('/users', validate.query(getUserValidationSchema), function (req, res) {
   db.collections('customers').findOne({_id: req.query.id}, function (err, customer) {
      res.json(customer);
   });
});</code></pre>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We say that
            </div>
          </div>
          <h3>Using JSon Schema Validation</h3>
          <div class="byline">
            <div class="classy">
              is always a
            </div>
          </div>
          <h3>good idea</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We say that it also
            </div>
          </div>
          <h3>helps you document </h3>
          <div class="byline">
            <div class="classy">
              your
            </div>
          </div>
          <h3>API</h3>
          <div class="byline">
            <div class="classy">
              if you plan to
            </div>
          </div>
          <h3>expose it</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="boom-save">
        <div class="content"></div>
      </section>

      <section data-bespoke-state="subject-change">
        <div class="content">
          <h2>XSS</h2>
        </div>
      </section>

      <section>
        <div class="content">
          <input type="submit" value="Go to unsafe URL" onclick="goToUnsafeUrl()" />
          <input type="submit" value="Clean params" onclick="cleanParams()" />
        </div>
      </section>

      <section data-bespoke-state="boom">
        <div class="content">
        </div>
      </section>

      <section>
        <div class="content">
          <div class="unbrokenline"></div>
          <h3>XSS</h3>
          <div class="byline">
            <div class="classy">
              means
            </div>
          </div>
          <h3>Inserting</h3>
          <div class="byline">
            <div class="classy">
              a
            </div>
          </div>
          <h3>JS Snippet</h3>
          <div class="byline">
            <div class="classy">
              that will be
            </div>
          </div>
          <h3>Served to other users</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>


      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              As
            </div>
          </div>
          <h3>Tokens</h3>
          <div class="byline">
            <div class="classy">
              can be
            </div>
          </div>
          <h3>Accessed</h3>
          <div class="byline">
            <div class="classy">
              from
            </div>
          </div>
          <h3>Javascript</h3>
          <div class="byline">
            <div class="classy">
              they're
            </div>
          </div>
          <h3>vulnerable</h3>
          <div class="byline">
            <div class="classy">
              to this attack
            </div>
          </div>
        </div>
      </section>

      <section>
        <div class="content">
          <div class="unbrokenline"></div>
          <h3>HTTP Only Cookies</h3>
          <div class="byline">
            <div class="classy">
              are
            </div>
          </div>
          <h3>not vulnerable</h3>
          <div class="byline">
            <div class="classy">
              to this attack since they
            </div>
          </div>
          <h3>can't be accessed</h3>
          <div class="byline">
            <div class="classy">
              from
            </div>
          </div>
          <h3>Javascript</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="chuck">
        <div class="content">
          <div class="byline">
            <div class="classy">
              We recommend
            </div>
          </div>
          <h3>Sanitizing all HTML &amp; JS inputs</h3>
          <div class="byline">
            <div class="classy">
              since that will make it
            </div>
          </div>
          <h3>harder to insert a XSS</h3>
          <div class="unbrokenline"></div>
        </div>
      </section>

      <section data-bespoke-state="boom-save">
        <div class="content">
        </div>
      </section>


      <section>
        <div class="content">
          <div class="byline">
            <div class="classy">
              This is the end of the presentation, so
            </div>
          </div>
          <h3>Thank you for listening</h3>
          <div class="byline">
            <div class="classy">
              or at least pretending to
            </div>
          </div>
        </div>
      </section>

      <section data-bespoke-state="final" class="intro">
        <div class="content">
          <div class="byline">
            <div class="classy">
              This has been
            </div>
          </div>
          <h1>Are your SPAs safe?</h1>
          <div class="byline">
            <div class="classy">
              by Eugenio Pace
            </div>
          </div>
          <div class="profile">
            <div class="rounded-image">
              <img src="img/gonto.jpeg">
            </div>
            <h3>@eugenio_pace</h3>
          </div>
        </div>
      </section>

    </article>
    <script type="text/javascript">
      WebFontConfig = {
        google: { families: [ 'Tauri::latin', 'Alegreya:400italic:latin' ] }
      };
      (function() {
        var wf = document.createElement('script');
        wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
          '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
        wf.type = 'text/javascript';
        wf.async = 'true';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(wf, s);
      })();
    </script>
    <script src="js/bespoke.js"></script>
    <script src="js/prism.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/deck.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/app.bootstrap.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.xss.js"></script>
    </body>
</html>
